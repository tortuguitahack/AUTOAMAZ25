{
  "metadata": {
    "version": 3,
    "name": "amzdiluz-v3",
    "description": "Flujo ultra-optimizado ATECHANY para ventas inmediatas Amazon con IA, validación robusta, logging, seguridad y distribución multicanal avanzada."
  },
  "flow": {
    "modules": [
      {
        "id": "inputValidationModule",
        "type": "custom:validateInput",
        "parameters": {
          "requiredFields": ["name", "link", "image"],
          "onError": "loggerModule"
        }
      },
      {
        "id": "googleSheetsModule",
        "type": "google-sheets:watchRows",
        "parameters": {
          "sheetId": "{{env.GOOGLE_SHEET_ID}}",
          "range": "Ecosistema Global!A2:F",
          "limit": 100
        }
      },
      {
        "id": "dedupeModule",
        "type": "custom:deduplicate",
        "parameters": {
          "uniqueField": "link"
        }
      },
      {
        "id": "gptModule",
        "type": "openai:chat-completion",
        "parameters": {
          "model": "gpt-4o",
          "prompt": "Actúa como una experta en ventas irresistibles. Redacta una descripción de menos de 30 palabras, usando hipnosis conversacional, lenguaje emocional, persuasión extrema y llamado a la acción directo para el producto: {{2.name}}.",
          "max_tokens": 100,
          "retryOnFail": 2,
          "validateWordLimit": 30
        }
      },
      {
        "id": "linkBuilderModule",
        "type": "tools:textAggregator",
        "parameters": {
          "template": "{{2.link}}?tag={{env.AMAZON_TAG}}&utm_source=atechany&utm_medium=ai&utm_campaign=autoaff_{{timestamp}}"
        }
      },
      {
        "id": "airtableModule",
        "type": "airtable:createRecord",
        "parameters": {
          "baseId": "{{env.AIRTABLE_BASE_ID}}",
          "tableId": "{{env.AIRTABLE_TABLE_ID}}",
          "fields": {
            "Producto": "{{2.name}}",
            "LinkAmazon": "{{5.text}}",
            "Descripción GPT": "{{4.choices[0].message.content}}"
          }
        }
      },
      {
        "id": "pinterestModule",
        "type": "pinterest:createPin",
        "parameters": {
          "boardId": "{{env.PINTEREST_BOARD_ID}}",
          "title": "{{2.name}}",
          "description": "{{4.choices[0].message.content}}",
          "link": "{{5.text}}",
          "imageUrl": "{{2.image}}"
        }
      },
      {
        "id": "redditModule",
        "type": "reddit:submitPost",
        "parameters": {
          "subreddit": "{{env.REDDIT_SUBREDDIT}}",
          "title": "{{2.name}}",
          "content": "{{4.choices[0].message.content}}\nCompra aquí 👉 {{5.text}}"
        }
      },
      {
        "id": "notionWebhookModule",
        "type": "webhook:sendData",
        "parameters": {
          "url": "{{env.NOTION_WEBHOOK_URL}}",
          "payload": {
            "producto": "{{2.name}}",
            "mensaje": "🚨 ¡Clic detectado! Revisa en Amazon: {{5.text}}"
          }
        }
      },
      {
        "id": "loggerModule",
        "type": "custom:logger",
        "parameters": {
          "logLevel": "info",
          "logFields": [
            "timestamp", "module", "status", "product", "link", "error"
          ]
        }
      }
    ],
    "connections": [
      { "source": "googleSheetsModule", "target": "inputValidationModule" },
      { "source": "inputValidationModule", "target": "dedupeModule" },
      { "source": "dedupeModule", "target": "gptModule" },
      { "source": "dedupeModule", "target": "linkBuilderModule" },
      { "source": "gptModule", "target": "airtableModule" },
      { "source": "linkBuilderModule", "target": "airtableModule" },
      { "source": "gptModule", "target": "pinterestModule" },
      { "source": "linkBuilderModule", "target": "pinterestModule" },
      { "source": "gptModule", "target": "redditModule" },
      { "source": "linkBuilderModule", "target": "redditModule" },
      { "source": "linkBuilderModule", "target": "notionWebhookModule" },
      { "source": "airtableModule", "target": "loggerModule" },
      { "source": "pinterestModule", "target": "loggerModule" },
      { "source": "redditModule", "target": "loggerModule" },
      { "source": "notionWebhookModule", "target": "loggerModule" }
    ]
  }
}